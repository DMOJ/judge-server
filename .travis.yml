udo: required
dist: bionic
services:
  - docker
language: minimal
env:
  matrix:
  - PYTHON_VERSION=3.6 DMOJ_USE_SECCOMP="yes"
  - PYTHON_VERSION=3.7 DMOJ_USE_SECCOMP="yes"
  - PYTHON_VERSION=3.6 DMOJ_USE_SECCOMP="no"
  - PYTHON_VERSION=3.7 DMOJ_USE_SECCOMP="no"
matrix:
  include:
  - name: flake8
    stage: lint
    language: python
    python: 3.7
    env: LINTER="yes"
    install: pip install flake8 flake8-import-order flake8-future-import flake8-commas flake8-logging-format
    script:
      - flake8 --version
      - flake8
stages:
  - lint
  - test
install:
  - time docker pull dmoj/runtimes-tier1
  - |
    if [ "$PYTHON_VERSION" != 3.7 ]; then
      curl -L "$(curl -s https://api.github.com/repos/DMOJ/runtimes-python/releases |
          jq -r '[.[].assets | flatten | .[] | select(.name | startswith("python'"$PYTHON_VERSION"'")) | .browser_download_url][0]')" |
        tar -xz
    fi
script:
  - |
    cat > run <<EOF
    #!/bin/bash
    cd /code
    if [ "$PYTHON_VERSION" != 3.7 ]; then
      PATH=/code/python$PYTHON_VERSION/bin:$PATH
      pip3 install cython
    fi
    pip3 install -e .
    dmoj-autoconf -V
    EOF
  - chmod a+x run
  - docker run -e PYTHON_VERSION="$PYTHON_VERSION" -e DMOJ_USE_SECCOMP="$DMOJ_USE_SECCOMP" -v "$(pwd):/code" --cap-add=SYS_PTRACE dmoj/runtimes-tier1
notifications:
  slack:
    secure: "cJMFsXwvAZxSR/p8WFYUAtJmPxnq+MZKhXQgaHZp7D0tveh6v0/O/GDfO+3B3Ep7/SBNiAj/wfH/ivDVjiSWVN/2DYSiHtzMZ9Jkq2CQzMzX5u3l7J04bO617K8+eRGOFQcYj+GPRntF4GebSgfMuhXwba2N/KjAA9QMKOTlJpU="
